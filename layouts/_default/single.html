{{define "main"}}
<article>
  <header class="mb-4 bg-primary-600">
    <span class="py-96">
      <h1 class="section-container py-16 text-5xl font-black text-center text-white", style="text-wrap: balance; padding: 3rem">
        {{ .Title }}
      </h1>
    </span>
  </header>
  <div class="max-w-2xl mx-auto mt-8 mb-2">
    <div class="px-6">
      {{ with .Params.featured_image }} {{ with resources.Get . }} {{ $small := (.Resize "400x webp q80").RelPermalink
      }} {{ $medium := (.Resize "550x webp q80").RelPermalink }} {{ $large := (.Resize "900x webp q80").RelPermalink }}
      {{ $featuredimage := (.Resize "1500x webp q80").RelPermalink }}
      <img
        src="{{ $featuredimage }}"
        srcset="
        {{- with $small -}}, {{.}} 400w{{- end -}}
        {{- with $medium -}}, {{.}} 550w{{- end -}}
        {{- with $large -}}, {{.}} 768w{{- end -}}
        {{- with $featuredimage -}}, {{.}} 1100w{{- end -}}"
        class="object-fill overflow-hidden rounded-lg shadow-lg"
        width="100%"
        alt="{{ .Params.title }}"
      />
      {{ end }} {{ end }}
      
      <!-- Featured image caption (only for posts) -->
      {{ if and (eq .Section "posts") .Params.caption }}
      <div class="featured-image-caption">
        <p>{{ .Params.caption | markdownify }}</p>
      </div>
      {{ end }}
    </div>
  </div>
  
  <!-- Author and date information (only for posts) -->
  {{ if eq .Section "posts" }}
  <div class="post-author-container">
    <div class="post-author-card">
      {{/*  <div class="post-author-avatar">
        {{ with .Params.authorimage }}
        {{ with resources.Get . }}
        {{ $authorimage := (.Resize "48x webp").RelPermalink }}
        <img src="{{ $authorimage }}" alt="{{ $.Params.author }}">
        {{ end }}
        {{ end }}
      </div>  */}}
      {{/*  <div class="post-author-info">
        <p class="post-author-name">
          {{ .Params.author }}
        </p>  */}}
        <div class="post-author-meta">
          <time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">{{ .Date.Format "January 2, 2006" }}</time>
        </div>
      </div>
    </div>
  </div>
  {{ end }}

  <!-- " {{.Content}}" pulls from the markdown content of the corresponding _index.md -->
  <div class="max-w-2xl px-6 pt-6 pb-16 mx-auto prose dark:prose-invert dark:text-white">{{.Content}}</div>
  
  <!-- Related Articles Section (only for posts) -->
  {{ if eq .Section "posts" }}
  <div class="related-articles-container">
    <h3 class="related-articles-heading">Related Articles</h3>
    <div class="related-articles-list">
      {{ $currentPage := . }}
      {{ $currentTags := .Params.tags }}
      
      <!-- Get all posts except current one, sorted by date (newest first) -->
      {{ $allPosts := sort (where (where site.RegularPages "Section" "posts") "Permalink" "!=" .Permalink) "Date" "desc" }}
      
      <!-- Create a single scored list: posts with matching tags get priority -->
      {{ $scoredPosts := slice }}
      {{ $now := now.Unix }}
      {{ range $allPosts }}
        {{ $score := 0 }}
        {{ $tagMatchCount := 0 }}
        
        <!-- Count matching tags -->
        {{ range .Params.tags }}
          {{ if in $currentTags . }}
            {{ $tagMatchCount = add $tagMatchCount 1 }}
          {{ end }}
        {{ end }}
        
        <!-- Tag score: 1000 points per matching tag -->
        {{ $tagScore := mul $tagMatchCount 1000 }}
        
        <!-- Recency score: more recent posts get higher scores (0-100 scale) -->
        {{ $daysSincePost := div (sub $now .Date.Unix) 86400 }}
        {{ $recencyScore := sub 100 (div $daysSincePost 365) }} <!-- 1 point lost per year -->
        {{ if lt $recencyScore 0 }}{{ $recencyScore = 0 }}{{ end }}
        
        <!-- Combined score: tag matches heavily weighted, recency as tiebreaker -->
        {{ $score = add $tagScore $recencyScore }}
        
        {{ $scoredPosts = $scoredPosts | append (dict "page" . "score" $score "tagCount" $tagMatchCount) }}
      {{ end }}
      
      <!-- Sort by score (highest first) and take first 3 -->
      {{ $sortedPosts := sort $scoredPosts "score" "desc" }}
      {{ $relatedPages := slice }}
      {{ range first 3 $sortedPosts }}
        {{ $relatedPages = $relatedPages | append .page }}
      {{ end }}
      
      <!-- Display first 3 related posts -->
      {{ range first 3 $relatedPages }}
      <article class="related-article-item">
        {{ with .Params.featured_image }}
        {{ with resources.Get . }}
        {{ $relatedimage := (.Resize "120x80 webp q80").RelPermalink }}
        <div class="related-article-image">
          <a href="{{ $.Permalink }}">
            <img src="{{ $relatedimage }}" alt="{{ $.Title }}">
          </a>
        </div>
        {{ end }}
        {{ end }}
        <div class="related-article-content">
          <h4 class="related-article-title">
            <a href="{{ .Permalink }}">
              {{ .Title }}
            </a>
          </h4>
          <p class="related-article-summary">
            {{ .Params.summary }}
          </p>
          <div class="related-article-meta">
            <time datetime="{{ .Date.Format "2006-01-02T15:04:05Z07:00" }}">{{ .Date.Format "Jan 2, 2006" }}</time>
            <span>&middot;</span>
            <span>{{ math.Round (div (countwords .Content) 220.0) }} min read</span>
          </div>
        </div>
      </article>
      {{ end }}
    </div>
  </div>
  {{ end }}
</article>
{{end}}
